---
format:
  revealjs:
    auto-stretch: false
    margin: 0
    slide-number: true
    scrollable: true
    preview-links: auto
    page-layout: custom
    logo: imagenes/logo_portada2.png
    css: ine_quarto_styles.css
    chalkboard: 
      boardmarker-width: 20
      buttons: false
    # footer: <https://quarto.org>
engine: knitr
knitr:
  opts_chunk: 
    echo: TRUE
    R.options:
      width: 120
---

#


[]{.linea-superior} 
[]{.linea-inferior} 

<!---
 <img src="imagenes/logo_portada2.png" style="width: 20%"/>  
--->

<img src="imagenes/logo_portada2.png" width="20%"/>  


[**Implementación del estándar de evaluación de calidad en encuestas económicas: fundamentos y aplicación práctica en R mediante el paquete calidad**]{.big-par .center-justified}

[**Área de Ciencia de Datos**]{.medium-par.center-justified}

[**Unidad de Gobierno de Datos**]{.small-par.center-justified}

[**Agosto 2025**]{.big-par .center-justified}



## Objetivos de la presentación  

::: {.medium-par}

- Dar a conocer las nuevas funcionalidades del paquete calidad
- Demostrar cómo implementar el estándar para encuestas económicas

:::

## Antes de comenzar

<br>

<br>

<br>

[⚠️ La versión actual del paquete siempre puede mejorar ⚠️]{.center}

<br>

. . .

[Quedamos atentos a su feedback 😀]{.center}




  
## Paquete calidad


:::: {layout-ncol=2}
 
::: {.fragment .small-par .center}
 

<img src="imagenes/estandares.PNG" width="100%"/>
 
:::
 
::: {.fragment .small-par .center}

<img src="imagenes/plots/logo_calidad.png" width="20%"/>

 
[Estándar de hogares INE](https://www.ine.gob.cl/docs/default-source/institucionalidad/buenas-prácticas/clasificaciones-y-estandares/estándar-evaluación-de-calidad-de-estimaciones-publicación-27022020.pdf)

[Estándar de encuestas económicas INE](https://www.ine.gob.cl/docs/default-source/buenas-practicas/directrices-metodologicas/estandares/documentos/estándar-evaluación-de-calidad-de-estimaciones-económicas.pdf?sfvrsn=201fbeb9_2)

[Estándar CEPAL](https://repositorio.cepal.org/server/api/core/bitstreams/4e2e55fc-3429-4619-8b6a-0bd5357b23b5/content)

[Estándar regional](https://repositorio.cepal.org/server/api/core/bitstreams/f04569e6-4f38-42e7-a32b-e0b298e0ab9c/content)

:::
 
::::




## Paquete calidad | Flujo

:::{.incremental .medium-par}

- Dos grandes funcionalidades:

  1. **Realizar la estimación**
  
      - Funciones *create_prop()*, *create_mean()*, *create_size()* y *create_total()*
   
  2. **Realizar la evaluación de la estimación** (*función assess()*)
    

- *calidad* se apoya en el paquete *survey* para realizar las estimaciones


:::

. . . 

[<img src="imagenes/thomas-lumley.jpg" width="10%"/>]{.center}

## Paquete calidad | Funciones create_*

:::{.incremental .medium-par}
- Las funciones *create_()* generan los insumos necesarios para realizar la evaluación.

- Los parámetros principales son:

  - *var* : Variable a estimar
  - *domains*: Dominio de interés.
  - *subpop*: Subpoblación de referencia (variable *dummy* que realiza filtro de los datos).
  - *design*: Diseño de muestra creado con *survey*

- Por defecto nos retorna los insumos: **se, df, n y cv**.

- Adicionalmente, estas funciones nos pueden retornar el **deff, ess, log_cv y ci**.

:::

## Paquete calidad | Función assess

:::{.incremental .medium-par}

- Función *assess()*: evaluación del estándar

  - **Parámetros principales**:
    
    1. *table*: Tabla con las estimaciones generadas con funciones *create_...()*.
    
    2. *scheme*: String que indica el estándar a evaluar, este puede ser "chile", "eclac_2020", "eclac_2023" y **"chile_economics"**.
    
    3. *publish*: Booleano, *TRUE* evalúa el porcentaje de estimaciones fiables en el tabulado completo. Default *FALSE*.
    
    4. *ratio_between_0_1*: Booleano, *TRUE* indica que la estimación corresponde a una proporción o razón entre 0 y 1. Por defecto es **TRUE** y se evalúa solo cuando tenemos una clase proporción (estimación con *create_prop*).
    
    
:::




## [Estándar de calidad para encuestas económicas (1/3)]{.big-par}

Recordemos un poco el estándar de encuestas económicas:

[<img src="imagenes/plots/estandar_economicas.png" width="75%"/>]{.center} 



## [Estándar de calidad para encuestas económicas (2/3)]{.big-par}

:::{.incremental .medium-par}

- Parámetros particulares para el estándar de económicas en  *assess()*:

  1. **domain_info**: *TRUE* implica que la estimación coincide con un estrato de muestreo. Default *FALSE*.
  
  2. **table_n_obj**: Dataframe que contiene el tamaño de muestra objetivo (**n_obj**) de los dominios indicados en la estimación. 
     
     -⚠️Es importante que en este dataframe los nombres de los dominios **coincidan** con los utilizados en la función *create_()* y que la columna del tamaño objetivo se llame **n_obj**.

:::

## [Estándar de calidad para encuestas económicas (3/3)]{.big-par}


⚠️Si no hay información, el paquete tomará una decisión conservadora ⚠️

[<img src="imagenes/flujo_conservador.PNG" width="65%"/>]{.center} 


## Aplicación 

::: {.medium-par .incremental}

Usaremos los datos de la **VII ELE**, disponibles en el paquete

Estimaremos y evaluaremos la productividad salarial (razón entre el Valor agregado 2022 y Remuneración total bruta del personal contratado) por tamaño y actividad.

⚠️No soy experto en la ELE⚠️

:::

. . .

<br>

[¡Vamos a R 🚀!]{.center}


## Primeros pasos

Debemos instalar calidad y cargar algunas dependencias

```{r, eval=FALSE, echo=TRUE}
install.packages('calidad')
```

```{r, echo=TRUE}
library(calidad)    
library(survey)     # para crear diseño de muestra
library(dplyr)  
```

## Cargando datos

El paquete cuenta con datos de prueba de la ELE7 (Encuesta Longitudinal de Empresas)

```{r, echo=TRUE}
head(ELE7, 3) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 15)

```
## Declaramos el diseño

```{r}
options(survey.lonely.psu = 'remove')    # indicamos tratamiento upm

## diseño de muestra con factor de expansión transversal
dc_ele <- svydesign(ids = ~rol_ficticio,
                    weights = ~fe_transversal,
                    strata = ~estrato,
                    fpc = ~pob,                 # correccion por poblacion finita
                    data = ELE7)
```

## Estimando proporciones

Productividad salarial (Valor agregado / remuneración bruta de personal contratado)

```{r, echo=TRUE}
## sin dominios
create_prop(var= 'VA_2022f',
            denominator = 'REMP_TOTAL',
            design = dc_ele)



```

. . . 


```{r}
# según codigo de tamaño y codido de actividad
prod_salarial <- create_prop('VA_2022f',
                             denominator = 'REMP_TOTAL',
                             domains = 'cod_tamano+ cod_actividad',
                             design = dc_ele)

```

```{r, echo=FALSE}
prod_salarial %>%
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16) 
```


## Nuevos pasos del estándar  

Necesitamos el tamaño de muestra objetivo 

. . .

El paquete cuenta con una tabla para la ELE7 😀  

```{r}
ELE7_n_obj %>%
  select(-cod_actividad) %>% 
  head(4) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 14)


```



## Agregando muestra objetivo (error)  


```{r, error=TRUE}

assess(prod_salarial,                
       scheme = 'chile_economics',   # indicamos criterio
       domain_info = T,              # ¿pertenece a dominio planificado?
       table_n_obj = ELE7_n_obj)



```


❌Las clases de las columnas no coinciden

. . .

```{r}

str(ELE7_n_obj)
str(prod_salarial)
```



## Agregando muestra objetivo  

Podemos modificar la tabla auxiliar para ajustarla a la salida de create

```{r}
# modifiquemos la tabla ELE7_n_obj
ELE7_n_obj2 <- ELE7_n_obj %>%
  mutate(cod_actividad = cod_actividad_letra,
         cod_tamano = as.character(cod_tamano))


evaluacion_estandar <- assess(prod_salarial,
                              scheme = 'chile_economics',
                              domain_info = T,
                              table_n_obj = ELE7_n_obj2, # tabla con clases corregidas
                              ratio_between_0_1 = FALSE) # no es una estimación definida entre 0 y 1

```

## Revisemos el resultado

```{r}
# revisión del estado final para n<30:
evaluacion_estandar %>%
  select(cod_tamano, cod_actividad, stat, n, compliance_rate, label) %>% 
  filter(n<30) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16)
```

## Hagamos un experimento

Modifiquemos un tamaño objetivo, para subir artificialmente la tasa de logro

```{r}
ELE7_n_obj2 %>% 
  filter(cod_tamano == '2' & cod_actividad== 'B') %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16)
```
. . .

```{r}
ELE7_n_obj3 <- ELE7_n_obj2 %>%
  mutate(n_obj = ifelse(cod_tamano == '2' & cod_actividad== 'B', 20, n_obj))
```

## Hagamos un experimento

```{r}
evaluacion_modificada <- assess(prod_salarial,
                                scheme = 'chile_economics',
                                domain_info = T,
                                table_n_obj = ELE7_n_obj3,
                                ratio_between_0_1 = FALSE)

evaluacion_modificada %>%
  select(cod_tamano, cod_actividad, stat, n, compliance_rate, label) %>% 
  filter(n<30) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16)

```
## Siempre puede haber problemas

**¿Qué pasa si se hace imposible incluir el dataframe en la función assess?** 🤔

. . .

Podemos agregar directamente la columna n_obj en la salida de create  

```{r}
# tabla prod_salarial le agregamos los tamaños objetivos:
prod_salarial2 <- prod_salarial %>%
  left_join(ELE7_n_obj2 %>%
              select(-cod_actividad_letra),
            by = c('cod_tamano', 'cod_actividad'))

# verificamos que no se hayan generado NAs:
is.na(prod_salarial2$n_obj) %>% sum()

# realizamos la evaluación:
evaluacion_estandar2 <- assess(prod_salarial2,
                               scheme = 'chile_economics',
                               domain_info = T,
                               ratio_between_0_1 = FALSE)

```

## Ausencia de muestra objetivo

**¿Qué pasa si no cuento con datos de muestra objetivo?** 🤔

. . .

El paquete etiquetará como no fiable todas las estimaciones con n < 30  

```{r}
# No incluímos información sobre muestra objetivo
evaluacion_sin_nobj <- assess(prod_salarial, 
                              scheme = 'chile_economics',
                              domain_info = T, 
                              ratio_between_0_1 = FALSE)

## revisión del estado final para n<30
evaluacion_sin_nobj %>%
  select(cod_tamano, cod_actividad, stat, n, compliance_rate, label) %>% 
  filter(n<30) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16)
```

## Evaluación del tabulado

```{r}
evaluacion_estandar_publish <- assess(prod_salarial,
                                      scheme = 'chile_economics',
                                      domain_info = TRUE,
                                      table_n_obj = ELE7_n_obj2,      
                                      ratio_between_0_1 = FALSE,
                                      publish = TRUE) # parámetro de publicación

evaluacion_estandar_publish %>% 
  select(cod_tamano, cod_actividad, stat, n, compliance_rate, label, publication) %>%
  head() %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(font_size = 16)



```

## Evaluación del tabulado

```{r}
evaluacion_estandar_publish %>% 
  select(label) %>% 
  table() %>%
  prop.table()

```


## Para finalizar

::: {.medium-par .incremental}

- Para mayor información sobre el uso del paquete, visita los tutoriales en el sitio del INE [link](https://www.ine.gob.cl/calidad-estadistica/directrices-metodologicas/tutorial-paquete-calidad) y en cran [link](https://cran.r-project.org/web/packages/calidad/vignettes/tutorial.html)

- Si alguien está interesado/a en colaborar en la creación de nuevas funcionalidades, puede realizarlo a través de la página github.com/inesscc/calidad 💻🛠️

- ¡Muchas gracias al departamento de Estadísticas Económicas y al Subdepartamento de Marcos y Muestras por la ayuda y feedback 🚀!



:::

. . .

[**Quedo atento a sus comentarios 👀**]{.center}


#

[]{.linea-superior} 
[]{.linea-inferior} 


<img src="imagenes/logo_portada2.png" width="20%"/>  

[**Implementación del estándar de evaluación de calidad en encuestas económicas: fundamentos y aplicación práctica en R mediante el paquete calidad**]{.big-par .center-justified}

[**Área de Ciencia de Datos**]{.medium-par.center-justified}

[**Unidad de Gobierno de Datos**]{.small-par.center-justified}

[**Agosto 2025**]{.big-par .center-justified}


